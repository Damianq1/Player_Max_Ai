name: üîê Sign + Release APK

on:
  workflow_dispatch:
    inputs:
      apk_name:
        description: 'APK do podpisania'
        required: true
        default: 'app-release-unsigned.apk'

jobs:
  sign:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - uses: actions/checkout@v4
    
    - name: üì• Download unsigned APK
      uses: actions/download-artifact@v4
      with:
        name: Ultimate_Player_ALL_APKs
        
    - name: üîê Setup signing
      env:
        KEYSTORE_BASE64: ${{ secrets.KEystore_BASE64 }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      run: |
        mkdir -p ~/.android
        echo $KEYSTORE_BASE64 | base64 -di > keystore.jks
        
    - name: üîê Sign APK
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore keystore.jks \
        "${{ github.event.inputs.apk_name }}" "$KEY_ALIAS" <<< "$KEY_PASSWORD"
        
        # Align APK
        zipalign -v 4 "${{ github.event.inputs.apk_name }}" signed.apk
        
    - name: üì§ Upload Signed APK
      uses: actions/upload-artifact@v4
      with:
        name: Ultimate_Player_SIGNED
        path: signed.apk
        
    - name: üöÄ Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.0-signed
        name: Ultimate Player v1.0.0 SIGNED
        body: |
          üé¨ **Ultimate Player v1.0.0 - SIGNED APK**
          ‚úÖ 100 funkcji | LibVLC 3.6 | Android TV/Phone
        files: signed.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
