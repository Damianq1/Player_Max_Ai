name: Build & Release PlayerMaxAi APK

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Pobierz kod repozytorium
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Ustaw JDK 17 (bo u≈ºywasz Java 17 w build.gradle)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Nadaj uprawnienia do gradlew (bardzo wa≈ºne na Linuxie)
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. Buduj release APK (assembleRelease)
      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace

      # 5. Znajd≈∫ wygenerowany APK
      - name: Locate APK
        id: find-apk
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*release.apk" | head -n 1)
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT

   name: üîê Keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.KEystore_BASE64 }}
      run: |
        echo "$KEYSTORE_BASE64" | base64 --decode > ultimate.keystore
        
    # SIGNING
    - name: üîê SIGN APK
      env:
        STORE_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASS: ${{ secrets.KEY_PASSWORD }}
      run: |
        # Znajd≈∫ APK (dok≈Çadnie)
        APK=$(find app/build/outputs/apk -name "*release*.apk" | head -1)
        [ -n "$APK" ] || { echo "‚ùå NO APK!"; exit 1; }
        echo "‚úÖ Found APK: $APK"
        
        # Sign
        jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore ultimate.keystore -storepass "$STORE_PASS" \
          "$APK" "$KEY_ALIAS" <<< "$KEY_PASS"
          
        # Align
        zipalign -v 4 "$APK" Ultimate_Player_v1.0.0-signed.apk

      # 7. Upload APK jako artifact (dostƒôpny do pobrania po buildzie)
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PlayerMaxAi-latest-apk
          path: ${{ steps.find-apk.outputs.APK_PATH }}
          retention-days: 7

      # 8. (Opcjonalnie) Automatyczny release + tag + nadpisanie najnowszego pliku
      - name: Create Release & Upload APK
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          prerelease: true
          generate_release_notes: true
          files: ${{ steps.find-apk.outputs.APK_PATH }}
          overwrite: true   # ‚Üê NADPISUJE poprzedni plik o tej samej nazwie tagu

env:
  # Je≈õli u≈ºywasz keystore w Secrets (zalecane!)
  # KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE_BASE64 }}
  # (trzeba wcze≈õniej zakodowaƒá keystore base64 i wrzuciƒá do repo Secrets)